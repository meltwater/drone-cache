branches:
  - master

pipeline:
  clone:
    image: plugins/git
    tags: true

  restore-cache:
      image: meltwater/drone-cache:dev
      pull: true
      restore: true
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  restore-cache-with-key:
      image: meltwater/drone-cache:dev
      pull: true
      restore: true
      cache_key: '{{ .Repo.Name }}_{{ checksum "go.mod" }}_{{ checksum "go.sum" }}_{{ arch }}_{{ os }}'
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  restore-cache-with-gzip:
      image: meltwater/drone-cache:dev
      pull: true
      restore: true
      cache_key: "gzip"
      archive_format: "gzip"
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  restore-cache-with-filesystem:
      image: meltwater/drone-cache:dev
      pull: true
      backend: "filesystem"
      restore: true
      cache_key: "volume"
      archive_format: "gzip"
      # filesystem_cache_root: "/tmp/cache"
      mount:
        - 'vendor'
      volumes:
        - '/drone/tmp/cache:/tmp/cache'

  restore-cache-debug:
      image: meltwater/drone-cache:dev
      pull: true
      restore: true
      debug: true

  build:
    image: golang:1.11-alpine
    pull: true
    secrets: [aws_access_key_id, aws_secret_access_key]
    commands:
      - apk add --update make git
      - make drone-cache

  test:
    image: golang:1.11-alpine
    pull: true
    environment:
      CGO_ENABLED: '0'
      TEST_ENDPOINT: filestorage:9000
    commands:
      - go test -v -mod=vendor -cover ./... # NOTICE: -race: Needs CGO enabled
    volumes:
      - '/drone/tmp/testcache:/drone/src/github.com/meltwater/drone-cache/testcache/cache'

  analyze:
    image: golang:1.11-alpine
    pull: true
    environment:
      CGO_ENABLED: '0'
    commands:
      - wget -O - -q https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh| sh -s v1.14.0
      - ./bin/golangci-lint run -v --enable-all -D gochecknoglobals

  rebuild-cache:
      image: meltwater/drone-cache:dev
      pull: true
      rebuild: true
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  rebuild-cache-with-key:
      image: meltwater/drone-cache:dev
      pull: true
      rebuild: true
      cache_key: '{{ .Repo.Name }}_{{ checksum "go.mod" }}_{{ checksum "go.sum" }}_{{ arch }}_{{ os }}'
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  rebuild-cache-with-gzip:
      image: meltwater/drone-cache:dev
      pull: true
      rebuild: true
      cache_key: "gzip"
      archive_format: "gzip"
      bucket: drone-cache-bucket
      secrets: [aws_access_key_id, aws_secret_access_key]
      region: eu-west-1
      mount:
        - 'vendor'

  rebuild-cache-with-filesystem:
      image: meltwater/drone-cache:dev
      pull: true
      backend: "filesystem"
      rebuild: true
      cache_key: "volume"
      archive_format: "gzip"
      # filesystem_cache_root: "/tmp/cache"
      mount:
        - 'vendor'
      volumes:
        - '/drone/tmp/cache:/tmp/cache'

  docker-release-dev:
    image: plugins/docker
    pull: true
    repo: meltwater/drone-cache
    tags: dev
    secrets: [docker_username, docker_password]
    when:
      branch: [master]
      event: [push]

  docker-release-tag:
    image: plugins/docker
    repo: meltwater/drone-cache
    tags: '${DRONE_TAG}'
    auto_tag: true
    secrets: [docker_username, docker_password]
    when:
      event: tag
      status: success
      ref: refs/tags/*

  github-release-tag:
    image: golang:1.11 # golang:1.11-alpine
    secrets: [github_token]
    commands:
      - git status
      - curl -sL https://git.io/goreleaser | bash
      - git status
    when:
      event: tag
      status: success
      ref: refs/tags/*

services:
  filestorage:
    image: minio/minio:RELEASE.2018-10-06T00-15-16Z
    environment:
      MINIO_ACCESS_KEY: AKIAIOSFODNN7EXAMPLE
      MINIO_SECRET_KEY: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
      MINIO_REGION: eu-west-1
    ports:
      - 9000:9000
    command: server /data
